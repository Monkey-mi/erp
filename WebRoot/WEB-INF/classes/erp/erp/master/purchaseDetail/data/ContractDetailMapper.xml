<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="erp.erp.master.purchaseDetail.data.ContractDetailMapper">


<insert id="addContractDetail" parameterType="erp.erp.master.purchaseDetail.model.ContractDetail" keyProperty="htxh">
	insert into dbo.htmxb
	(
		htbh,
		htxh,
		clhh,
		cltx1,
		cltx2,
		cltx3,
		jhlb,
		jldw,
		cgsl,
		ycgl,
		cgdj,
		zzsl,
		kzdj,
		wbhl,
		wbbh,
		wbdj,
		cgrq,
		ghzq,
		jhrq,
		hqjq,
		ddbh,
		ddxh,
		jhbh,
		jhxh,
		zxhtbh,
		zxhtxh,
		cgbh,
		cgxh,
		sgbh,
		sgxh,
		sdck,
		bzsm,
		hsbm,
		xzbj,
		wkjq,
		gxsj,
		fzdw,
		fzsl,
		fzkj,
		sqbh,
		sqxh,
		csxs1,
		csxs2,
		csxs3,
		csxs4,
		csxs5,
		csxs6,
		csxs7,
		csxs8,
		csjg,
		kjlx,
		htbz,
		khbh,
		cpbh,
		pxxh,
		wxbj,
		ysgg,
		dlgs,
		rksl,
		ggcs,
		clbz,
		zzlx,
		zzyx,
		zzbj,
		zzrm,
		zzsj,
		mxzs,
		cpxj,
		bzxx,
		scbj,
		cjjhrq,
		pzqrbj,
		pzqrrm,
		pzqrsj,
		mjh,
		cfbh,
		cfxh,
		fach,
		khxh,
		ywms,
		pono,
		xmsjbc,
		xjqrbj,
		zldj
	)
	values
	(
		#{htbh},
		#{htxh},
		#{clhh},
		#{cltx1},
		#{cltx2},
		#{cltx3},
		#{jhlb},
		#{jldw},
		#{cgsl},
		#{ycgl},
		#{cgdj},
		#{zzsl},
		#{kzdj},
		#{wbhl},
		#{wbbh},
		#{wbdj},
		#{cgrq},
		#{ghzq},
		#{jhrq},
		#{hqjq},
		#{ddbh},
		#{ddxh},
		#{jhbh},
		#{jhxh},
		#{zxhtbh},
		#{zxhtxh},
		#{cgbh},
		#{cgxh},
		#{sgbh},
		#{sgxh},
		#{sdck},
		#{bzsm},
		#{hsbm},
		#{xzbj},
		#{wkjq},
		#{gxsj},
		#{fzdw},
		#{fzsl},
		#{fzkj},
		#{sqbh},
		#{sqxh},
		#{csxs1},
		#{csxs2},
		#{csxs3},
		#{csxs4},
		#{csxs5},
		#{csxs6},
		#{csxs7},
		#{csxs8},
		#{csjg},
		#{kjlx},
		#{htbz},
		#{khbh},
		#{cpbh},
		#{pxxh},
		#{wxbj},
		#{ysgg},
		#{dlgs},
		#{rksl},
		#{ggcs},
		#{clbz},
		#{zzlx},
		#{zzyx},
		#{zzbj},
		#{zzrm},
		#{zzsj},
		#{mxzs},
		#{cpxj},
		#{bzxx},
		#{scbj},
		#{cjjhrq},
		#{pzqrbj},
		#{pzqrrm},
		#{pzqrsj},
		#{mjh},
		#{cfbh},
		#{cfxh},
		#{fach},
		#{khxh},
		#{ywms},
		#{pono},
		#{xmsjbc},
		#{xjqrbj},
		#{zldj}
	)
</insert>
<update id="updatePurchasePlanCltx" parameterType="map">
	update cgjhmxb set cltx1=htmxb.cltx1 from htmxb with (nolock) inner join cgjhmxb with (nolock) on cgjhmxb.cgbh=htmxb.cgbh and cgjhmxb.cgxh=htmxb.cgxh
		where htmxb.htbh=#{htbh};
</update>
<!-- wcbj -->
<update id="updateContractWcbj" parameterType="map">
	update cgjhb set wcbj=(case when (
	select count(*) from cgjhmxb where cgbh=cgjhmxb_zzbj.cgbh and not (zzbj=1 or wcbj=1))=0 then 1 else 0 end)
		from cgjhb,(select cgbh,cgxh from htmxb where cgbh&lt;&gt;0 and cgxh&lt;&gt;0 and htbh=#{htbh})cgjhmxb_zzbj
		where cgjhb.cgbh=cgjhmxb_zzbj.cgbh;
</update>
<!--用采购合同明细中的最小交货时间(dwsj)和最小采购日期(cgrq)刷至该采购合同中。  -->
<update id="updateContractTime" parameterType="map">
	update cghtb set cgrq=(select min(cgrq) from htmxb with (nolock) where htmxb.htbh=#{htbh})
	,jhrq= (select min(jhrq)  from htmxb with (nolock) where htmxb.htbh=#{htbh})
	from cghtb with (nolock) where cghtb.htbh=#{htbh};
</update>
<update id="updateContractCgsl" parameterType="map">
	set htzs=(select sum(cgsl) from htmxb with (nolock) where htmxb.htbh=cghtb.htbh),
		htze=(select sum(round((case when kjlx=1 then fzsl else cgsl end)*cgdj,2)) from htmxb with (nolock) where htmxb.htbh=cghtb.htbh),
		wbze=(select sum(round((case when kjlx=1 then fzsl else cgsl end)*wbdj,2)) from htmxb with (nolock) where htmxb.htbh=cghtb.htbh)
		where cghtb.htbh=#{htbh} and (cghtb.gdbj=0 or cghtb.gdbj=null);
</update>
<update id="updatePurchasePlanZzbj" parameterType="map">
	update cgjhmxb set zzbj= case when isnull(cgjhmxb.cgsl,0) - isnull(cgjhmxb.wxsl,0) - isnull(cgjhmxb.htsl,0) &lt; 5 and isnull(cgjhmxb.cgsl,0) - isnull(cgjhmxb.wxsl,0) - isnull(cgjhmxb.htsl,0) &gt; 0 then 1 else 0 end,zzyx=case when isnull(cgjhmxb.cgsl,0) - isnull(cgjhmxb.wxsl,0) - isnull(cgjhmxb.htsl,0) &lt; 5 and isnull(cgjhmxb.cgsl,0) - isnull(cgjhmxb.wxsl,0) - isnull(cgjhmxb.htsl,0) &gt; 0 then '未转数小于5千克，系统自动中止' else '' end,
		wcbj=case when isnull(cgjhmxb.cgsl,0) - isnull(cgjhmxb.wxsl,0) - isnull(cgjhmxb.htsl,0) &lt; 5 and isnull(cgjhmxb.cgsl,0) - isnull(cgjhmxb.wxsl,0) - isnull(cgjhmxb.htsl,0) &gt; 0 then 1 else 0 end from htmxb 
		inner join cgjhmxb with (nolock) on cgjhmxb.cgbh=htmxb.cgbh and cgjhmxb.cgxh=htmxb.cgxh
		inner join clbmb with (nolock) on cgjhmxb.clhh=clbmb.clhh 
		where htmxb.htbh=#{htbh} and clbmb.fzzbj in (5,6);
</update>
<update id="updateContractDetail" parameterType="erp.erp.master.purchaseDetail.model.ContractDetail">
	update dbo.htmxb
		set
			zldj = #{zldj},
			htbh = #{htbh},
			htxh = #{htxh},
			clhh = #{clhh},
			cltx1 = #{cltx1},
			cltx2 = #{cltx2},
			cltx3 = #{cltx3},
			jhlb = #{jhlb},
			jldw = #{jldw},
			cgsl = #{cgsl},
			ycgl = #{ycgl},
			cgdj = #{cgdj},
			zzsl = #{zzsl},
			kzdj = #{kzdj},
			wbhl = #{wbhl},
			wbbh = #{wbbh},
			wbdj = #{wbdj},
			cgrq = #{cgrq},
			ghzq = #{ghzq},
			jhrq = #{jhrq},
			hqjq = #{hqjq},
			ddbh = #{ddbh},
			ddxh = #{ddxh},
			jhbh = #{jhbh},
			jhxh = #{jhxh},
			zxhtbh = #{zxhtbh},
			zxhtxh = #{zxhtxh},
			cgbh = #{cgbh},
			cgxh = #{cgxh},
			sgbh = #{sgbh},
			sgxh = #{sgxh},
			sdck = #{sdck},
			bzsm = #{bzsm},
			hsbm = #{hsbm},
			xzbj = #{xzbj},
			wkjq = #{wkjq},
			gxsj = #{gxsj},
			fzdw = #{fzdw},
			fzsl = #{fzsl},
			fzkj = #{fzkj},
			sqbh = #{sqbh},
			sqxh = #{sqxh},
			csxs1 = #{csxs1},
			csxs2 = #{csxs2},
			csxs3 = #{csxs3},
			csxs4 = #{csxs4},
			csxs5 = #{csxs5},
			csxs6 = #{csxs6},
			csxs7 = #{csxs7},
			csxs8 = #{csxs8},
			csjg = #{csjg},
			kjlx = #{kjlx},
			htbz = #{htbz},
			khbh = #{khbh},
			cpbh = #{cpbh},
			pxxh = #{pxxh},
			wxbj = #{wxbj},
			ysgg = #{ysgg},
			dlgs = #{dlgs},
			rksl = #{rksl},
			ggcs = #{ggcs},
			clbz = #{clbz},
			zzlx = #{zzlx},
			zzyx = #{zzyx},
			zzbj = #{zzbj},
			zzrm = #{zzrm},
			zzsj = #{zzsj},
			mxzs = #{mxzs},
			cpxj = #{cpxj},
			bzxx = #{bzxx},
			scbj = #{scbj},
			cjjhrq = #{cjjhrq},
			pzqrbj = #{pzqrbj},
			pzqrrm = #{pzqrrm},
			pzqrsj = #{pzqrsj},
			mjh = #{mjh},
			cfbh = #{cfbh},
			cfxh = #{cfxh},
			fach = #{fach},
			khxh = #{khxh},
			ywms = #{ywms},
			pono = #{pono},
			xmsjbc = #{xmsjbc},
			xjqrbj = #{xjqrbj}
		where htbh=#{htbh} and htxh = #{htxh}
</update>
<delete id="deleteHtmxDdbzcfxxb" parameterType="map">
	delete from htmx_ddbzcfxxb where not exists 
	(select * from htmxb where htmxb.htbh=htmx_ddbzcfxxb.htbh and htmxb.htxh=htmx_ddbzcfxxb.htxh);
</delete>
<delete id="deleteContractDetail" parameterType="erp.erp.master.purchaseDetail.model.ContractDetail">
	delete from dbo.htmxb
	where htbh=#{htbh} and htxh = #{htxh}
</delete>
</mapper>
